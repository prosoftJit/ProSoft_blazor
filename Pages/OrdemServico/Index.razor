@page "/OrdemServico/Index"
@using ProSoft.Data
@using Microsoft.EntityFrameworkCore
@using ProSoft.Components

<PageHeader Title="Ordens de Serviço" Description="Ordens de serviço ao cliente">
    <BarItems>
        <RadzenButton ButtonStyle="Radzen.ButtonStyle.Primary" Icon="add" Text="Ordem" Click="AddOs" />
    </BarItems>
</PageHeader>

<GenericTemplate Items="ordensDeServico">
    <TableHeader>
        <th>Id</th>
        <th>Número</th>
        <th>Data</th>
        <th>Cliente</th>
        <th></th>
    </TableHeader>
    <RowTemplate Context="os">
        <td class="text-center"><a href="" @onclick="()=>askEdit=os" @onclick:preventDefault>@os.IdOrdemDeServico.ToString("000000")</a></td>
        <td></td>
        <td>@os.Data.ToShortDateString()</td>
        <td></td>
        <td width="1%"><a href="" @onclick="()=>askDelete=os.IdOrdemDeServico" @onclick:preventDefault><i class="oi oi-trash"></i></a></td>
    </RowTemplate>
</GenericTemplate>

@if (askEdit != null)
{
    <ModalDialog Title="Ordens de Serviço" Size="modal-fullscreen" OnCancel="()=>askEdit=null">
        <ModalBody>
            <PageHeader Title="Ordem de Serviço"></PageHeader>
            <OS idOrdemDeServico="askEdit.IdOrdemDeServico" />
        </ModalBody>
        <ModalFooter>
            <button form="editForm" type="submit" Class="btn btn-success">Salvar</button>
        </ModalFooter>
    </ModalDialog>
}

@if (askDelete > 0)
{
    @* <ModalConfirm Title="Excluir" Message="Confirma exclusão?"></ModalConfirm> *@
}

@code {
    ordemdeservico? askEdit = null;
    long askDelete = 0;
    [Inject] NotificationService notificationService { get; set; } = default!;
    ordemdeservico[] ordens = Array.Empty<ordemdeservico>();

    void Delete()
    {
        if (askDelete > 0) {
            ordemdeservico os = ctx.ordensdeservico.Find(askDelete)!;
            ctx.ordensdeservico.Remove(os);
            ctx.SaveChanges();
            LoadOrdens();
            notificationService.Notify(NotificationSeverity.Success, "Ordem de Serviço", "Ordem de serviço excluída com sucesso!");
        }
    }
    void AddOs() {
        askEdit = new();
    }

    ordemdeservico[]? ordensDeServico;
    Contexto ctx = new Contexto();

    protected override async Task OnInitializedAsync()
    {
        ordensDeServico = await LoadOrdens();
    }

    Task<ordemdeservico[]> LoadOrdens()
    {
        try
        {
//            PreloadService.Show();
            return Task.FromResult(ctx.ordensdeservico.OrderBy(k => k.Data).ToArray());
        }
        catch
        {

        }
        finally
        {
//           PreloadService.Hide();
        }
        return Task.FromResult( Array.Empty<ordemdeservico>() );
    }
}
