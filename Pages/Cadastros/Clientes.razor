@page "/Clientes"
@using ProSoft.Data
@using ProSoft.Components
@using ProSoft.Services
@using Microsoft.EntityFrameworkCore

<PageHeader Title="Clientes" Description="Listagem de clientes cadastrados no sistema">
</PageHeader>

<FluentDataGrid Items="ctx.clientes.OrderBy(k=>k.Nome)" TGridItem="cliente" Pagination="paginator" >
    <PropertyColumn Title="Id" Property='p => p.idCliente.ToString("000000")' Sortable="true" />
    <PropertyColumn Title="Nome" Property="p => p.Nome" Sortable="true" />
    <TemplateColumn Title="Actions" Align="@Align.End" Context="item">
        <FluentButton IconEnd="@(new Icons.Regular.Size12.Edit())" OnClick="()=>askEdit=item" />
        <FluentButton IconEnd="@(new Icons.Regular.Size12.Delete())"  />
    </TemplateColumn>
</FluentDataGrid>

<FluentPaginator State="paginator" >
    <PaginationTextTemplate>
        <strong>@paginator.TotalItemCount</strong> items.
        <FluentButton Appearance=Appearance.Hypertext IconStart="new Icons.Regular.Size12.Add()" OnClick="()=>askEdit=new()">Adicionar</FluentButton>
    </PaginationTextTemplate>
    <PaginationTextTemplate>
        Página <strong>@(paginator.CurrentPageIndex+1)</strong> de <strong>@(paginator.LastPageIndex+1)</strong>
    </PaginationTextTemplate>
</FluentPaginator>

@if (askDelete != null)
{
    @* <ProSoft.Co ConfirmDialog Message="Confirma exclusão?" OnClose="DeleteDialogClosed"></ConfirmDialog> *@
}

@if (!EditHidden)
{
    <FluentDialog @bind-Hidden="EditHidden" TrapFocus="true" >
        <FluentDialogHeader><h5>Editar cliente</h5></FluentDialogHeader>
        <ProSoft.Pages.Cadastros.Cliente Model="askEdit" />
    
        <FluentDialogFooter>
            <FluentButton Appearance="Appearance.Hypertext" OnClick="()=>EditHidden=true">Fechar</FluentButton>
            <FluentButton Id="submit" FormId="cliForm">Salvar</FluentButton>
        </FluentDialogFooter>
    </FluentDialog>
}


@* @if (askEdit != null)
{
    <ModalDialog Title="Cliente" Size="modal-fullscreen" OnCancel="_=>askEdit=null">
        <ModalBody>
        </ModalBody>
        <ModalFooter>
            <RadzenButton Icon=save form=cliForm ButtonType=Radzen.ButtonType.Submit Text=Salvar />
        </ModalFooter>
    </ModalDialog>
}
 *@
@code {
    cliente? askEdit=null;

    Contexto ctx = new();

    cliente? askDelete = null;
    bool EditHidden { get { return askEdit == null; } set { if (value) askEdit = null; } }

    PaginationState paginator = new PaginationState { ItemsPerPage = 10 };

    private void ClientSave()
    {
        @* showDialogNewClient = false;
        await clienteForm?.Submit();
        await LoadClientes();
        StateHasChanged(); *@
    }
    public void AskDelete(long idCliente)
    {
        cliente cli = ctx.clientes.First(k => k.idCliente == idCliente);

        var c = (from cl in ctx.clientes
                where cl.idCliente == idCliente
                let c1 = cl.Compras.Count()
                let c2 = cl.Equipamentos.Count()
                let c3 = cl.Pagamentos.Count()
                let c4 = cl.Orcamentos.Count()
                select c1 + c2 + c3 + c4).First();

        if (c > 0)
        {
//            toastService.ShowToast("Impossível excluir o cliente: " + cli.Nome, ToastLevel.Warning);
            return;
        }

        askDelete = cli;
    }
    public void DeleteDialogClosed(bool value)
    {
        if (value && askDelete != null)
        {
            ctx.clientes.Remove(askDelete);
            ctx.SaveChanges();
        }
        askDelete = null;
        StateHasChanged();
    }

    private cliente[]? clientes;

    protected override async Task OnInitializedAsync()
    {
        await LoadClientes();
    }

    Task LoadClientes()
    {
        clientes = ctx.clientes.OrderBy(k => k.Nome).ToArray();
        return Task.FromResult(clientes);
    }
}
