@page "/Cadastros/Cliente/{idCliente:long}"
@using System.ComponentModel.DataAnnotations
@using ProSoft.Data
@using ProSoft.Services

@inject DialogService dialogService

<RadzenTemplateForm TItem=cliente Data="Model" Submit="Submit" id="cliForm">

    <DataAnnotationsValidator />
    <ValidationSummary />

    <RadzenRow class="mb-3">
        <RadzenColumn Size="2">
            <RadzenFormField Text="Id do Cliente" class="w-100">
                <RadzenNumeric Value="@Model.idCliente" Format="000000" ShowUpDown=false TextAlign="TextAlign.Center" Disabled=true></RadzenNumeric>
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="10" SizeLG="4">
            <RadzenFormField Text="Nome" class="w-100">
                <RadzenTextBox @bind-Value="Model.Nome" AutoComplete="false" Name="Nome" />
                <RadzenRequiredValidator Component="Nome" Text="É necessário informar o nome" />
            </RadzenFormField>
        </RadzenColumn>
    </RadzenRow>

    <ProSoft.Shared.Endereco endereco="Model" />

    <RadzenRow class="mt-3">
        <RadzenColumn Size="4">
            <RadzenFormField Text="CPF" class="w-100">
                <RadzenMask @bind-Value="Model.CPF" Mask="***.***.***-**" CharacterPattern="[0-9]" />
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="4">
            <RadzenFormField Text="Email" class="w-100">
                <RadzenTextBox @bind-Value="Model.Email" />
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="4">
            <RadzenFormField Text="RG" class="w-100">
                <RadzenMask @bind-Value="Model.RG" Mask="***.***.***-*" CharacterPattern="[0-9]" />
            </RadzenFormField>
        </RadzenColumn>
    </RadzenRow>

</RadzenTemplateForm>

@code {
    Contexto ctx = new();

    [Parameter] public long? idCliente { get; set; }

    cliente Model { get; set; } = new();

    protected override void OnInitialized()
    {
        Model = ctx.clientes.Find(idCliente) ?? new();
        if (Model == null)
            Model = new cliente();
    }

    [Inject] NotificationService notificationService { get; set; } = default!;

    void Submit(cliente cli)
    {
        Console.Write("Salvando...");
        Console.WriteLine(Model.idCliente.ToString());
        if (Model.idCliente == 0)
            ctx.Entry(Model).State = EntityState.Added;
        else
            ctx.Entry(Model).State = EntityState.Modified;

        ctx.SaveChanges();

        Console.WriteLine("Saved");
        notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Cadastro de clientes", Detail = "Alterações do cliente foram salvas com sucesso!", Duration = 4000 });
    }
}